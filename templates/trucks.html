<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Trucks</title>
    <link rel="stylesheet" href="/static/css/trucks.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar">
                <ul>
                    <li>
                        <a href="#">
                            <div class="nav-title">
                                <span class="main-title">SIAi</span><br>
                                <span class="sub-title">TRANSPORTER</span>
                            </div>
                        </a>
                    </li>
                    <li><a href="/trucks">View Trucks</a></li>
                    <li><a href="/bid">Bid to Load</a></li>
                    <li><a href="/history">View History</a></li>
                    <li><a href="/load-pool">Load Pool</a></li>
                    <li><a href="/chat">Chat</a></li>
                    <li><a href="/analytics">Analytics</a></li>
                    <li><a href="/documents">Documents</a></li>
                    <li><a href="#">Online Market</a></li>
                </ul>
                <div class="search-bar">
                    <input type="text" placeholder="Search for Beira loads">
                </div>
            </nav>
        </header>

        <main>
            <div class="booked-trucks">
                <h2>Fleet Management</h2>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Truck Reg</th>
                            <th>Truck Type</th>
                            <th>Trailer 1 Reg</th>
                            <th>Trailer 2 Reg</th>
                            <th>Driver Name</th>
                            <th>ID Number</th>
                            <th>Passport Number</th>
                            <th>License Number</th>
                            <th>Phone Number</th>
                            <th>Select</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Use Jinja loop to iterate through trucks -->
                        {% for truck in trucks %}
                        <tr>
                            <td>{{ truck.id }}</td>
                            <td>{{ truck.truck_reg }}</td>
                            <td>{{ truck.truck_type }}</td>
                            <td>{{ truck.trailer1_reg }}</td>
                            <td>{{ truck.trailer2_reg }}</td>
                            <td>{{ truck.driver_name }}</td>
                            <td>{{ truck.id_number }}</td>
                            <td>{{ truck.passport_number }}</td>
                            <td>{{ truck.license_number }}</td>
                            <td>{{ truck.phone_number }}</td>
                            <td><input type="checkbox" name="truck_checkbox" value="{{ truck.id }}" id="book-{{ truck.id }}"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div>
                <button class="f-btn" onclick="handleTruckAction('book')">Book Selected Trucks</button>
                <button class="f-btn" onclick="handleTruckAction('delete')">Delete Selected Trucks</button>
                <button class="f-btn" onclick="handleTruckAction('add')">Add Truck</button>
            </div>
            
                <div class="footer-nav">
                    <button class="footer-btn">Back</button>
                    <button class="footer-btn">Send</button>
                </div>
            </div>
        </main>

        <footer>
            <div class="footer-container">
                <div class="footer-column">
                    <h3>SiAi</h3>
                    <p>AI powered Transport Management System. Post and Go...</p>
                    <p><i>Contact: +123 456 3455</i></p>
                </div>
                <div class="footer-column">
                    <h3>Menu</h3>
                    <ul>
                        <li>Products</li>
                        <li>Services</li>
                        <li>Analytics</li>
                        <li>About Us</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Account</h3>
                    <ul>
                        <li><a href="/account"> My Account</a></li>
                        <li>Checkout</li>
                        <li>My Cart</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Stay Connected</h3>
                    <ul>
                        <li>Facebook</li>
                        <li>Instagram</li>
                        <li>X</li>
                    </ul>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Function to handle adding, booking, or deleting trucks
        function handleTruckAction(actionType) {
            const selectedTrucks = [];
            const checkboxes = document.querySelectorAll(`input[name="truck_checkbox"]:checked`);
    
            checkboxes.forEach(checkbox => {
                selectedTrucks.push(checkbox.value);
            });
    
            if (selectedTrucks.length === 0) {
                alert(`Please select trucks to ${actionType}`);
                return;
            }
    
            // Fetch user metadata
            fetch('/get_user_metadata')
                .then(response => response.json())
                .then(metadata => {
                    // Prepare the event data to send to Flask
                    const eventData = {
                        event_name: `${actionType}_Truck`,  
                        user_id: metadata.user_id,
                        ip_address: metadata.ip_address,
                        timestamp: new Date().toISOString(),
                        user_agent: navigator.userAgent,
                        selected_trucks: selectedTrucks
                    };
    
                    // Send the data to Flask
                    sendTruckEvent(eventData);
                })
                .catch(error => {
                    console.error("Error fetching user metadata:", error);
                    alert("Failed to fetch user metadata.");
                });
        }
    
        // Function to send event data to the Flask backend
        function sendTruckEvent(eventData) {
            fetch('/truck_action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                const action = eventData.event_name.split('_')[0].toLowerCase(); // Get 'add', 'book', or 'delete'
                alert(`Trucks have been ${action}ed successfully!`);
                console.log(`${eventData.event_name} event sent successfully:`, data);
            })
            .catch(error => {
                console.error("Error sending truck event:", error);
                alert(`Error trying to ${eventData.event_name.split('_')[0]} the trucks. Please try again.`);
            });
        }
    </script>    
</body>
</html>
