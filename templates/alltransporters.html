<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Transporters</title>
    <link rel="stylesheet" href="/static/css/trucks.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600&display=swap" rel="stylesheet">
    
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar">
                <ul>
                    <li>
                        <a href="#">
                            <div class="nav-title">
                                <span class="main-title">SIAi</span><br>
                                <span class="sub-title">SHIPPER</span>
                            </div>
                        </a>
                    </li>
                    <li><a href="/load">Post Load</a></li>
                    <li><a href="/view-transporters">View Transporters</a></li>
                    <li><a href="/shipper-history">View History</a></li>
                    <li><a href="/view_offers">View Offers</a></li>
                    <li><a href="/shipper_chat">Chat</a></li>
                    <li><a href="/shipper_analytics">Analytics</a></li>
                    <li><a href="/shipper_documents">Documents</a></li>
                    <li><a href="#">Online Market</a></li>
                </ul>
                <div class="search-bar">
                    <input type="text" placeholder="Search for transporters" id="name-filter" oninput="filterTransporters()">
                </div>
            </nav>
        </header>

        <main>
            <div class="booked-trucks">
                <h2>View All Transporters</h2>
                <div class="filter-options">
                    <label for="rating-filter">Rating:</label>
                    <select id="rating-filter" onchange="filterTransporters()">
                        <option value="">All</option>
                        <option value="5">5 Stars</option>
                        <option value="4">4 Stars</option>
                        <option value="3">3 Stars</option>
                        <option value="2">2 Stars</option>
                        <option value="1">1 Star</option>
                    </select>

                    <label for="ranking-filter">Ranking:</label>
                    <select id="ranking-filter" onchange="filterTransporters()">
                        <option value="">All</option>
                        <option value="premium">Premium</option>
                        <option value="standard">Standard</option>
                    </select>

                    <label for="git-filter">G.I.T:</label>
                    <select id="git-filter" onchange="filterTransporters()">
                        <option value="">All</option>
                        <option value="1800">1800</option>
                        <option value="2000">2000</option>
                    </select>

                    <label for="fleet-size-filter">Fleet Size:</label>
                    <input type="number" id="fleet-size-filter" placeholder="Min Fleet Size" oninput="filterTransporters()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Fleet Size</th>
                            <th>G.I.T</th>
                            <th>Ranking</th>
                            <th>Rating</th>
                            <th>Add Favourite</th>         
                        </tr>
                    </thead>
                    <tbody id="transporter-table">
                        <!-- Use Jinja loop to iterate through transporters -->
                        {% for transporter in transporters %}
                        <tr data-name="{{ transporter.name }}" data-rating="{{ transporter.rating }}" data-ranking="{{ transporter.ranking }}" data-git="{{ transporter.git }}" data-fleet="{{ transporter.fleet_size }}">
                            <td>{{ loop.index }}</td>
                            <td><a href="#" onclick="viewTransporterDetails('{{ transporter.id }}')">{{ transporter.name }}</a></td>
                            <td>{{ transporter.fleet_size }}</td>
                            <td>{{ transporter.git }}</td>
                            <td>{{ transporter.ranking }}</td>
                            <td>
                                <!-- Display star ratings -->
                                {% for i in range(1, 6) %}
                                    <span class="star {% if i <= transporter.rating %}filled{% endif %}">&#9733;</span>
                                {% endfor %}
                            </td>
                            <td>
                                <button class="fav-button" onclick="toggleFavourite('{{ transporter.id }}')">
                                    <span class="heart-icon {% if transporter.is_favourite %}favourited{% else %}not-favourited{% endif %}" id="heart-{{ transporter.id }}">&#9829;</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="footer-nav">
                    <button class="footer-btn">Back</button>
                   
                </div>
            </div>
              <!-- Transporter details page, initially hidden -->
               
              <div class="inner-container" id="transporter-details" style="display: none;">
                <h2 id="transporter-name"></h2>
                <p id="transporter-routes"></p>
                <p id="transporter-reviews"> </p>

                 <!-- Hidden input for transporter_id -->
                 <input type="hidden" id="transporter_id">
                 <div id="add-review-section">
                    <h4>Add Your Rating and Review</h4>
                    <!-- Star Rating Section -->
                    <textarea id="reviews_text"  placeholder="Write your review here"></textarea><br>
    <div id="rating">
        <label for="rating-5" class="star">
            <input type="radio" id="rating-5" name="rating" value="5" onclick="setRating(5)">
            ★
        </label>
        <label for="rating-4" class="star">
            <input type="radio" id="rating-4" name="rating" value="4" onclick="setRating(4)">
            ★
        </label>
        <label for="rating-3" class="star">
            <input type="radio" id="rating-3" name="rating" value="3" onclick="setRating(3)">
            ★
        </label>
        <label for="rating-2" class="star">
<input type="radio" id="rating-2" name="rating" value="2" onclick="setRating(2)">
★
</label>
<label for="rating-1" class="star">
<input type="radio" id="rating-1" name="rating" value="1" onclick="setRating(1)">
★
</label>
</div> 
<button id="submit-review-btn">Submit Review</button>
                    </div>
                
               
                <button class="footer-btn" onclick="goBack()">Back to List</button>
            </div>
              
        </main>

        <footer>
            <div class="footer-container">
                <div class="footer-column">
                    <h3>SiAi</h3>
                    <p>AI powered Transport Management System. Post and Go...</p>
                    <p><i>Contact: +123 456 3455</i></p>
                </div>
                <div class="footer-column">
                    <h3>Menu</h3>
                    <ul>
                        <li>Products</li>
                        <li>Services</li>
                        <li>Analytics</li>
                        <li>About Us</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Account</h3>
                    <ul>
                        <li>My Account</li>
                        <li>Checkout</li>
                        <li>My Cart</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Stay Connected</h3>
                    <ul>
                        <li>Facebook</li>
                        <li>Instagram</li>
                        <li>X</li>
                    </ul>
                </div>
            </div>
            </footer>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedTransporter = null; 
            let selectedRating = 0; 

           // Function to set the rating when a user selects a star
    window.setRating = function (rating) {
        selectedRating = rating;
        console.log("Selected rating:", rating);

        // Highlight stars based on the selected rating
        const stars = document.querySelectorAll('.star input');
        stars.forEach((star, index) => {
            if (index < selectedRating) {
                star.parentElement.style.color = 'gold'; // Highlight selected stars
            } else {
                star.parentElement.style.color = ''; // Reset unselected stars
            }
        });
    };
    
            function viewTransporterDetails(transporterId) {
                document.getElementById('transporter_id').value = transporterId;
                // Get elements
                const transporterNameElement = document.getElementById('transporter-name');
                const transporterRoutesElement = document.getElementById('transporter-routes');
                const transporterReviewsElement = document.getElementById('transporter-reviews');
                const detailsContainer = document.getElementById('transporter-details');
    
                console.log("Fetching details for transporter ID:", transporterId);
    
                // Check if elements exist before setting properties
                if (!transporterNameElement || !transporterRoutesElement || !transporterReviewsElement) {
                    console.error("Error: Transporter details elements not found in the DOM.");
                    return;
                }
    
                // Show loading message in the name field
                transporterNameElement.innerHTML = "Loading...";
                transporterRoutesElement.innerHTML = "";
                transporterReviewsElement.innerHTML = "";
    
                fetch(`/get_transporter_details/${transporterId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            // Make sure the transporter details are visible
                            document.querySelector('.booked-trucks').style.display = 'none';
                            const detailsElement = document.getElementById('transporter-details');
    
                            // Check if the element exists
                            if (detailsElement) {
                                detailsElement.style.display = 'block';
    
                                // Check if elements exist before setting their properties
                                const nameElement = document.getElementById('transporter-name');
                                const routesElement = document.getElementById('transporter-routes');
                                const reviewsElement = document.getElementById('transporter-reviews');
    
                                if (nameElement && routesElement && reviewsElement) {
                                    nameElement.innerText = data.name || 'No Name Available';
                                    routesElement.innerText = 'Routes: ' + (data.routes || 'No Routes Available');
                                    reviewsElement.innerText = 'Reviews: ' + (data.reviews || 'No Reviews Available yet');
                                } else {
                                    console.error('Transporter name, reviews or routes element not found.');
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching transporter details:', error));
            }
    
    
            // Submit review function
            window.submitReview = function() {
                const reviewText = document.getElementById('reviews_text').value;
                const transporterId = document.getElementById('transporter_id').value;
                const username = "currentUser";
    
                if (selectedRating === 0) {
                    alert("Please select a star rating.");
                    return;
                }
    
                if (!reviewText.trim()) {
                    alert("Please write a review.");
                    return;
                }
    
                // Prepare the review data
                const reviewData = {
                    transporter_id: transporterId,
                    rating: selectedRating,
                    reviews_text: reviewText,
                    reviewer_name: username,
                    timestamp: new Date().toISOString() // Capture the current timestamp
                };
    
                // Send the review to the server
                fetch('/submit_review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reviewData)
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Review submitted successfully!');
                        return viewTransporterDetails(transporterId);
                } else {
            alert('Review submitted Successfully! ');
             }
            })
                .catch(error => console.error('Error submitting review:', error));
            };
           
    // Function to reset the stars
    function resetStars() {
        const stars = document.querySelectorAll('.star input');
        stars.forEach(star => {
            star.checked = false; // Uncheck all radio buttons
            star.parentElement.style.color = ''; // Reset star color
        });
        selectedRating = 0; // Reset selected rating
    }
    
            function filterTransporters() {
                const nameFilter = document.getElementById('name-filter').value.toLowerCase();
                const ratingFilter = document.getElementById('rating-filter').value;
                const rankingFilter = document.getElementById('ranking-filter').value;
                const gitFilter = document.getElementById('git-filter').value;
                const fleetSizeFilter = document.getElementById('fleet-size-filter').value;
    
                const rows = document.querySelectorAll('#transporter-table tr');
    
                rows.forEach(row => {
                    const name = row.getAttribute('data-name').toLowerCase();
                    const rating = row.getAttribute('data-rating');
                    const ranking = row.getAttribute('data-ranking');
                    const git = row.getAttribute('data-git');
                    const fleetSize = row.getAttribute('data-fleet');
    
                    const nameMatch = name.includes(nameFilter);
                    const ratingMatch = ratingFilter === '' || rating === ratingFilter;
                    const rankingMatch = rankingFilter === '' || ranking === rankingFilter;
                    const gitMatch = gitFilter === '' || git === gitFilter;
                    const fleetSizeMatch = fleetSizeFilter === '' || parseInt(fleetSize) >= parseInt(fleetSizeFilter);
    
                    row.style.display = (nameMatch && ratingMatch && rankingMatch && gitMatch && fleetSizeMatch) ? '' : 'none';
                });
            }
    
            function goBack() {
                document.getElementById('transporter-details').style.display = 'none';
                document.querySelector('.booked-trucks').style.display = 'block';
            }
    
            function toggleFavourite(transporterId) {
                const heartIcon = document.getElementById(`heart-${transporterId}`);
                const isCurrentlyFavourited = heartIcon.classList.contains('favourited');
    
                // Toggle favourite icon color class
                heartIcon.classList.toggle('favourited');
                heartIcon.classList.toggle('not-favourited');
    
                // Send the favourite action to Flask
                fetch('/toggle_favourite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transporter_id: transporterId, 
                        is_favourite: !isCurrentlyFavourited 
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    console.log('Favourite status updated:', data);
                })
                .catch(error => {
                    console.error('Error updating favourite status:', error);
                });
            }
            // Add event listener for the submit review button
    const submitReviewBtn = document.getElementById('submit-review-btn');
    if (submitReviewBtn) {
        submitReviewBtn.addEventListener('click', submitReview);
    }
    
            // Expose functions to the global scope if needed
            window.viewTransporterDetails = viewTransporterDetails;
            window.filterTransporters = filterTransporters;
            window.goBack = goBack;
            window.toggleFavourite = toggleFavourite;
        });
    </script>     
    </body>
    </html>
    
   
