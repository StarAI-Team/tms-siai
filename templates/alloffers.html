<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offers Page</title>
    <link rel="stylesheet" href="/static/css/offers.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="bid-container">
        <div class="left-side"></div>

        <div class="right-side">
            <!-- Dynamically load offer data from Flask -->
            {% for offer in offers %}
            <div class="load-item {% if offer.perfect_match %}perfect-match{% endif %}">
                <div class="load-details">
                    <p>
                        <!-- Offer name and details -->
                        <span class="load-name">{{ offer.name }}</span>
                        <span class="price">{{ offer.price }}</span>
                        <span class="offer-details">{{ offer.details }}</span>
                    </p>
                </div>
                {% if offer.perfect_match %}
                <div class="star-flashing">
                    <div class="star">Perfect Match!</div>
                </div>
                {% endif %}
                <button class="all-bid-button" 
                        data-id="{{ offer.id }}"
                        data-name="{{ offer.name }}"
                        data-details="{{ offer.details }}"
                        data-price="{{ offer.price }}">Accept</button>
            </div>
            {% endfor %}

            <button class="upgrade-button" onclick="window.location.href='/shipper-package'">Upgrade to Accept All</button>
            <button class="all-back-button" onclick="window.location.href='/shipper-dashboard'">Back</button>
        </div>
    </div>
    <script>
        // Handle Accept button click
        document.querySelectorAll('.all-bid-button').forEach(button => {
            button.addEventListener('click', function() {
                // Retrieve offer data from button's data attributes
                const offerId = this.getAttribute('data-id');
                const offerName = this.getAttribute('data-name');
                const offerDetails = this.getAttribute('data-details');
                const offerPrice = this.getAttribute('data-price');

                // Fetch user metadata
                fetch('/get_user_metadata')
                    .then(response => response.json())
                    .then(metadata => {
                        // Prepare event data including user metadata and form data
                        const eventData = {
                            event_name: 'Offer_Acceptance',
                            user_id: metadata.user_id,
                            ip_address: metadata.ip_address,
                            timestamp: new Date().toISOString(),
                            user_agent: navigator.userAgent,
                            form_data: {
                                offer_id: offerId,
                                name: offerName,
                                details: offerDetails,
                                price: offerPrice
                            }
                        };

                        // Call the function to submit the offer acceptance event
                        submitOfferAcceptance(eventData);
                    })
                    .catch(error => {
                        console.error('Error fetching user metadata:', error);
                        alert('Failed to fetch user metadata. Please try again.');
                    });
            });
        });

        // Function to send the offer acceptance event to Flask backend
        function submitOfferAcceptance(eventData) {
            fetch('/accept_offer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Offer accepted successfully:', data);
                alert('Offer accepted successfully!');
            })
            .catch(error => {
                console.error('Error accepting offer:', error);
                alert('There was an error accepting the offer. Please try again.');
            });
        }
    </script>
</body>
</html>
