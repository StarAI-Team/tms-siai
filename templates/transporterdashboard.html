<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600&display=swap" rel="stylesheet">
    <title>Transporter Dashboard</title>
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar">
                <ul>
                    <li>
                        <a href="#">
                            <div class="nav-title">
                                <span class="main-title">SIAi</span><br>
                                <span class="sub-title">TRANSPORTER</span>
                            </div>
                        </a>
                    </li>
                    <li><a href="/trucks">View Trucks</a></li>
                    <li><a href="/bid">Bid to Load</a></li>
                    <li><a href="/history">View History</a></li>
                    <li><a href="/load-pool">Load Pool</a></li>
                    <li><a href="/chat">Chat</a></li>
                    <li><a href="/analytics">Analytics</a></li>
                    <li><a href="/documents">Documents</a></li>
                    <li><a href="#">Online Market</a></li>
                </ul>
                <div class="search-bar">
                    <input type="text" placeholder="Search for Beira loads">
                </div>
            </nav>
        </header>

        <main>
            <div class="map">
                
                <iframe 
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d4439.8572745792035!2d30.983086911367764!3d-17.880017283023122!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x1931a176e43d4e1f%3A0xcb282feb3d12c814!2sStar%20International!5e1!3m2!1sen!2ses!4v1728304968205!5m2!1sen!2ses" 
                width="1000" 
                height="600" 
                style="border:0;" 
                allowfullscreen="" 
                loading="lazy" 
                referrerpolicy="no-referrer-when-downgrade">
                </iframe>
                </div>
        
                <section class="updates-section">
                    <h2>Updates</h2>
                    <div class="update" data-update-type="Pelcravia Accepted Offer">Pelcravia Accepted Offer - Description <span>9:41 AM</span></div>
                    <div class="update" data-update-type="Picked Up">Picked Up - Description <span>9:41 AM</span><button class="upload-btn">Upload</button></div>
                    <div class="update" data-update-type="In Transit">In Transit - Description <span>9:41 AM</span></div>
                    <div class="update" data-update-type="Done">Done - Send Documents <span>9:41 AM</span><button class="upload-btn">Upload</button></div>
                    <div class="update" data-update-type="Pending Payment">Pending Payment <span>9:41 AM</span></div>
                    <div class="update" data-update-type="Completed">Completed <span>9:41 AM</span></div>

                <section class="logistics-news-section">
                    <h2>Logistics News</h2>
                    <div class="news-item">News Headline 1 - Description <span>9:41 AM</span></div>
                    <div class="news-item">News Headline 2 - Description <span>10:30 AM</span></div>
                    <div class="news-item">News Headline 3 - Description <span>11:15 AM</span></div>
                </section>
            </section>             
            
        </main>  



        <section class="info-section">
            <div class="stats">
                <div class="stat">
                    <h2>Route Planning</h2>
                    <p>Traffic: <span>30%</span></p>
                    <p>Fuel: <span>2000L</span></p>
                </div>
                <div class="stat">
                    <h2>ETA</h2>
                    <p>Traffic: <span>30%</span></p>
                    <p>Road Quality: <span>30%</span></p>
                    <p>Weather: <span>2%</span></p>
                    <div class="countdown">Countdown to arrival: <span>22h 5m 20s remaining</span></div>
                </div>
                <div class="stat">
                    <h2>Predicted Risks</h2>
                    <p>Delays: <span>15%</span></p>
                    <p>Accidents: <span>0.2%</span></p>
                    <p>Theft: <span>90%</span></p>
                </div>
            </div>
        </section>   
        <section class="carousel-section">
            <div class="carousel">
                <div class="carousel-inner">
                    <a href="#"><img src="/static/images/onlinestore1.png" alt="Description 1" class="carousel-image"></a>
                    <a href="#"><img src="/static/images/onlinestore2.png" alt="Description 2" class="carousel-image"></a>
                    <a href="#"><img src="/static/images/onlinestore3.png" alt="Description 3" class="carousel-image"></a>
                </div>
                <button class="carousel-button prev" onclick="changeSlide(-1)">&#10094;</button>
                <button class="carousel-button next" onclick="changeSlide(1)">&#10095;</button>
            </div>
        </section>   

        <footer>
            <div class="footer-container">
                <div class="footer-column">
                    <h3>SIAi</h3>
                    <p>AI powered Transport Management System. Post and Go...</p>
                    <p><i>Contact: +123 456 3455</i></p>
                </div>
                <div class="footer-column">
                    <h3>Menu</h3>
                    <ul>
                        <li>Products</li>
                        <li>Services</li>
                        <li>Analytics</li>
                        <li>About Us</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Account</h3>
                    <ul>
                        <li><a href="/account"> My Account</a></li>
                        <li>Checkout</li>
                        <li>My Cart</li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Stay Connected</h3>
                    <ul>
                        <li>Facebook</li>
                        <li>Instagram</li>
                        <li>X</li>
                    </ul>
                </div>
            </div>
        </footer>
    </div>
    <script>
        let currentIndex = 0;
        const images = document.querySelectorAll('.carousel-image');
    
        function changeSlide(direction) {
            images[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + direction + images.length) % images.length;
            images[currentIndex].classList.add('active');
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            images[currentIndex].classList.add('active');
            const carousel = document.querySelector('.carousel');
            let isHovered = false;
    
            // Automatic scrolling for the carousel
            setInterval(() => {
                if (!isHovered) {
                    carousel.scrollBy({
                        left: carousel.offsetWidth,
                        behavior: 'smooth'
                    });
                    if (carousel.scrollLeft + carousel.offsetWidth >= carousel.scrollWidth) {
                        carousel.scrollTo({ left: 0, behavior: 'smooth' });
                    }
                }
            }, 3000); // Adjust the interval for your desired timing
    
            // Stop/start carousel on hover
            carousel.addEventListener('mouseover', () => isHovered = true);
            carousel.addEventListener('mouseout', () => isHovered = false);
        });
        document.addEventListener('DOMContentLoaded', () => {
        // Attach event listeners to "Upload" buttons
        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                console.log("Upload button clicked");
                const updateType = event.target.closest('.update').dataset.updateType;
                console.log("Update type:", updateType);
                handleFileUpload(event, updateType);
            });
        });
    });

    async function handleFileUpload(event, updateType) {
        try {
            console.log("Fetching user metadata...");

            // Fetch user metadata
            const metadataResponse = await fetch('/get_metadata');
            if (!metadataResponse.ok) {
                throw new Error(`Failed to fetch metadata: ${metadataResponse.status} ${metadataResponse.statusText}`);
            }
            const metadata = await metadataResponse.json();
            console.log("User metadata fetched:", metadata);

            // Create a FormData object to hold the file and metadata
            const formData = new FormData();
            formData.append('update_type', updateType);
            formData.append('user_id', metadata.user_id || ''); 
            formData.append('ip_address', metadata.ip_address || '');
            formData.append('timestamp', new Date().toISOString());
            formData.append('user_agent', navigator.userAgent);

            // File input creation for file selection
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.jpg,.jpeg,.png';

            // Handle file selection
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log("File selected:", file.name);

                    // Append the file with a dynamic field name
                    const fieldName = `file_${updateType.toLowerCase().replace(/ /g, '_')}`;
                    formData.append(fieldName, file);

                    console.log("Sending data to Flask endpoint...");
                    
                    // Send data to Flask endpoint
                    const response = await fetch('/transporter_updates', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Response from server:', result);
                    } else {
                        console.error('Error:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.log("Server response:", errorText);
                    }
                }
            });

            // Trigger file input click to open file selector
            console.log("Triggering file input for selection");
            fileInput.click();
        } catch (error) {
            console.error('Error submitting data:', error);
        }
    }
    


</script>
</body>
</html>
